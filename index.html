<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đang chuyển hướng...</title>
</head>
<body>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Kiểm tra kết nối mạng
            if (!navigator.onLine) {
                displayErrorMessage('Không có kết nối mạng. Vui lòng kiểm tra kết nối và thử lại.');
                return;
            }

            // Lấy toàn bộ phần sau dấu '?' trong URL
            var keyword = window.location.search.substring(1); // Đổi queryString thành keyword

            // Kiểm tra nếu có keyword hoặc refid
            if (keyword) {
                // Gọi hàm fetch để lấy link gốc
                fetchOriginalLink(keyword);
            }
            // Không cần hiển thị form tạo link rút gọn nếu không có keyword hoặc refid
        });

        function fetchOriginalLink(keywordOrRefid) {
            // Kiểm tra kết nối mạng
            if (!navigator.onLine) {
                displayErrorMessage('Không có kết nối mạng. Vui lòng kiểm tra kết nối và thử lại.');
                return;
            }

            // Xây dựng URL gọi đến Apps Script, mã hóa keyword nếu cần
            var url = `https://script.google.com/macros/s/AKfycbxL7lGHd25j9xqCXL5cjGZRHzP4vQCJdq2KCGpYEtNJDGVWI-BIKffSU2cYZ9qZiSp-8g/exec?action=redirectShortLink&keyword=${encodeURIComponent(keywordOrRefid)}`; // Gửi keyword

            fetch(url, {
                method: 'GET',
                cache: 'no-cache'
            })
                .then(response => {
                    if (!response.ok) {
                        // Phân biệt các loại lỗi và hiển thị thông báo cụ thể
                        if (response.status === 404) {
                            throw new Error('Không tìm thấy liên kết gốc. Vui lòng kiểm tra lại keyword hoặc refid.');
                        } else if (response.status === 500) {
                            throw new Error('Lỗi server. Vui lòng thử lại sau hoặc liên hệ với quản trị viên.');
                        } else {
                            throw new Error('Đã xảy ra lỗi khi lấy liên kết gốc. Vui lòng thử lại sau.');
                        }
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.originalLink) {
                        window.location.href = data.originalLink;
                    } else {
                        displayErrorMessage('Không tìm thấy liên kết gốc cho từ khóa hoặc refid đã cung cấp.');
                    }
                })
                .catch(error => {
                    console.error('Lỗi Fetch:', error.message);
                    displayErrorMessage(error.message);
                });
        }

        // Hàm để hiển thị thông báo lỗi
        function displayErrorMessage(message) {
            var errorContainer = document.getElementById('error-container');
            if (!errorContainer) {
                errorContainer = document.createElement('div');
                errorContainer.id = 'error-container';
                errorContainer.style.color = 'red';
                document.body.appendChild(errorContainer);
            }
            errorContainer.textContent = message;
        }
    </script>
</body>
</html>
