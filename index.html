document.addEventListener('DOMContentLoaded', function() {
    var keyword = new URLSearchParams(window.location.search).get('keyword');
    var refid = new URLSearchParams(window.location.search).get('refid');

    if (keyword || refid) {
        fetchOriginalLink(keyword || refid);
    } else {
        console.error('Không có từ khóa hoặc refid trong URL.');
        alert('Không có từ khóa hoặc refid trong URL.');
    }
});

function fetchOriginalLink(identifier) {
    var encodedIdentifier = encodeURIComponent(identifier);

    fetch(`https://script.google.com/macros/s/AKfycbwJgR1iLkDU-Hly1MHRR4kfUFpkmm27kE9bxwxEMFg0_UpV_moIIhSjR1sWLcNXcIR9bg/exec?keyword=${encodedIdentifier}&refid=${encodedIdentifier}`, {
        method: 'GET',
        cache: 'no-cache'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Phản hồi từ mạng không hợp lệ');
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.originalLink) {
            var isRefid = /^\d{6}$/.test(identifier);
            var redirectUrl = isRefid 
                ? (data.originalLink.includes('?') ? `${data.originalLink}&refid=${encodedIdentifier}` : `${data.originalLink}?refid=${encodedIdentifier}`)
                : data.originalLink;
            window.location.href = redirectUrl;
        } else {
            console.error('Không tìm thấy liên kết gốc cho từ khóa hoặc refid:', identifier);
            alert('Không tìm thấy liên kết gốc cho từ khóa hoặc refid.');
        }
    })
    .catch(error => {
        console.error('Lỗi Fetch:', error.message);
        alert('Đã xảy ra lỗi khi lấy liên kết gốc.');
    });
}
