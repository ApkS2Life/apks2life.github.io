<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lấy phần chuỗi truy vấn sau dấu '?' trong URL
    var queryString = window.location.search.substring(1);

    if (queryString) {
        // Phân tích chuỗi truy vấn để lấy keyword và refid
        var params = new URLSearchParams(queryString);
        var keyword = params.get('keyword');
        var refid = params.get('refid');

        if (keyword) {
            fetchOriginalLink(keyword, refid);
        } else {
            console.error('Không có từ khóa trong URL.');
            alert('Không có từ khóa trong URL.');
        }
    } else {
        console.error('Không có chuỗi truy vấn trong URL.');
        alert('Không có chuỗi truy vấn trong URL.');
    }
});

function fetchOriginalLink(keyword, refid) {
    // Chuyển đổi và mã hóa keyword
    var encodedKeyword = encodeURIComponent(keyword);

    // Xây dựng URL với keyword
    var url = `https://script.google.com/macros/s/AKfycbwJgR1iLkDU-Hly1MHRR4kfUFpkmm27kE9bxwxEMFg0_UpV_moIIhSjR1sWLcNXcIR9bg/exec?keyword=${encodedKeyword}`;

    fetch(url, {
        method: 'GET',
        cache: 'no-cache'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Phản hồi từ mạng không hợp lệ');
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.originalLink) {
            let redirectUrl = data.originalLink;

            // Nếu có refid, thêm nó vào URL gốc
            if (refid) {
                var encodedRefid = encodeURIComponent(refid);
                // Thêm refid vào URL gốc
                redirectUrl += (redirectUrl.includes('?') ? '&' : '?') + `refid=${encodedRefid}`;
            }

            // Sử dụng history.pushState để cập nhật URL mà không cần reload trang
            window.history.pushState({}, '', redirectUrl);

            // Hiển thị thông báo với URL mới (sau khi đã thêm refid)
            console.log('Link gốc với refid:', redirectUrl);

            // Tùy chọn: Nếu muốn tự động chuyển hướng sau khi gắn refid
            // window.location.href = redirectUrl;
        } else {
            console.error('Không tìm thấy liên kết gốc cho từ khóa:', keyword);
            alert('Không tìm thấy liên kết gốc cho từ khóa.');
        }
    })
    .catch(error => {
        console.error('Lỗi Fetch:', error.message);
        alert('Đã xảy ra lỗi khi lấy liên kết gốc.');
    });
}
</script>
