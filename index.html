document.addEventListener('DOMContentLoaded', function() {
    // Lấy keyword từ URL sau dấu '?'
    var urlParams = new URLSearchParams(window.location.search);
    var keyword = urlParams.get('keyword');

    if (keyword) {
        fetchOriginalLink(keyword);
    } else {
        console.error('Không có từ khóa trong URL.');
        alert('Không có từ khóa trong URL.');
    }
});

function fetchOriginalLink(keyword) {
    var encodedKeyword = encodeURIComponent(keyword);

    fetch(`https://script.google.com/macros/s/AKfycbwJgR1iLkDU-Hly1MHRR4kfUFpkmm27kE9bxwxEMFg0_UpV_moIIhSjR1sWLcNXcIR9bg/exec?keyword=${encodedKeyword}`, {
        method: 'GET',
        cache: 'no-cache'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.originalLink) {
            // Nếu keyword là chuỗi 6 chữ số
            if (/^\d{6}$/.test(keyword)) {
                // Thêm refid vào link gốc
                var originalLinkWithKeyword = data.originalLink.includes('?') 
                    ? `${data.originalLink}&refid=${encodedKeyword}`
                    : `${data.originalLink}?refid=${encodedKeyword}`;
                // Chuyển hướng đến link gốc với refid
                window.location.replace(originalLinkWithKeyword);
            } else {
                // Chuyển hướng đến link gốc mà không thêm refid
                window.location.replace(data.originalLink);
            }
        } else {
            alert('Không tìm thấy liên kết gốc.');
            console.error('Không tìm thấy liên kết gốc.');
        }
    })
    .catch(error => {
        console.error('Lỗi Fetch:', error.message);
        alert('Đã xảy ra lỗi khi lấy liên kết gốc.');
    });
}
