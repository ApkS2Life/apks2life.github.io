<script>
// Hàm để mã hóa keyword (refid không cần mã hóa)
function encodeKeyword(keywordOrRefid) {
    // Nếu là refid (số), không mã hóa
    if (!isNaN(keywordOrRefid)) {
        return keywordOrRefid;
    } 
    // Mã hóa nếu là keyword
    return encodeURIComponent(keywordOrRefid);
}

// Hàm để giải mã keyword
function decodeKeyword(keywordOrRefid) {
    // Nếu là refid (số), không cần giải mã
    if (!isNaN(keywordOrRefid)) {
        return keywordOrRefid;
    }
    // Giải mã nếu là keyword
    return decodeURIComponent(keywordOrRefid);
}

document.addEventListener('DOMContentLoaded', function() {
    // Lấy phần sau dấu '?' trong URL (keyword hoặc refid)
    var fullUrl = window.location.href;
    var keywordOrRefid = fullUrl.split('?')[1]; // Lấy chuỗi sau dấu '?'

    // Kiểm tra nếu có keyword hoặc refid
    if (keywordOrRefid) {
        // Gọi hàm fetch để lấy link gốc
        fetchOriginalLink(decodeKeyword(keywordOrRefid));
    } else {
        console.error('Không có từ khóa hoặc refid trong URL.');
        alert('Không có từ khóa hoặc refid trong URL.');
    }
});

function fetchOriginalLink(keywordOrRefid) {
    // Xây dựng URL gọi đến Apps Script, mã hóa keyword nếu cần
    var encodedKeywordOrRefid = encodeKeyword(keywordOrRefid);
    var url = `https://script.google.com/macros/s/AKfycbwJgR1iLkDU-Hly1MHRR4kfUFpkmm27kE9bxwxEMFg0_UpV_moIIhSjR1sWLcNXcIR9bg/exec?keyword=${encodedKeywordOrRefid}`;

    fetch(url, {
        method: 'GET',
        cache: 'no-cache'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Phản hồi từ mạng không hợp lệ');
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.originalLink) {
            var finalLink = data.originalLink;

            // Nếu keyword là số (refid), thêm refid vào link gốc
            if (!isNaN(keywordOrRefid)) {
                finalLink += `?refid=${keywordOrRefid}`;
            }

            // Chuyển hướng đến link gốc với refid (nếu có)
            window.location.href = finalLink;
        } else {
            console.error('Không tìm thấy liên kết gốc cho từ khóa hoặc refid:', keywordOrRefid);
            alert('Không tìm thấy liên kết gốc cho từ khóa hoặc refid.');
        }
    })
    .catch(error => {
        console.error('Lỗi Fetch:', error.message);
        alert('Đã xảy ra lỗi khi lấy liên kết gốc.');
    });
}
</script>
